-- [9] 설계 (쇼핑몰)

-- 상품 재고 현황
CREATE TABLE PRODUCT (
    P_CODE VARCHAR2(3)      PRIMARY KEY,
    P_NAME VARCHAR2(30)     NOT NULL,
    PRICE  NUMBER(7),
    STOCK  NUMBER(4),
    CHECK (PRICE >= 0),
    CHECK (STOCK >= 0) );
    
INSERT INTO PRODUCT VALUES ('A1', '맥주', 3000, 50);
INSERT INTO PRODUCT VALUES ('A2', '소주', 2000, 90);
INSERT INTO PRODUCT VALUES ('B1', '땅콩', 3500, 10);
INSERT INTO PRODUCT VALUES ('B2', '오징어', 5000, 10);
INSERT INTO PRODUCT VALUES ('C1', '기저귀', 7000, 10);

SELECT * FROM PRODUCT;

-- 고객 정보
CREATE TABLE CUSTOMER (
    C_ID      VARCHAR2(10)  PRIMARY KEY,
    C_NAME    VARCHAR2(30)  NOT NULL,
    C_ADDRESS VARCHAR2(300) NOT NULL,
    C_TEL     VARCHAR2(13)  UNIQUE,
    C_EMAIL   VARCHAR2(20) );

INSERT INTO CUSTOMER VALUES ('abc', '홍길동', '서울시 강남구', '010-1111-1111', 'hong@hong.com');
INSERT INTO CUSTOMER VALUES ('def', '전투왕', '서울시 서대문구', '010-2222-2222', 'fight@fight.com');

SELECT * FROM CUSTOMER;

-- 카트
CREATE SEQUENCE CART_SEQ
    MAXVALUE 9999
    NOCACHE
    NOCYCLE;

CREATE TABLE CART (
    SEQ     NUMBER(4)       PRIMARY KEY,
    C_ID    VARCHAR2(10)    REFERENCES CUSTOMER (C_ID),
    P_CODE  VARCHAR(3)      REFERENCES PRODUCT (P_CODE),
    AMOUNT  NUMBER(3),
    COST    NUMBER(7),
    CHECK (AMOUNT > 0),
    CHECK (COST > 0) );

-- 주문정보
CREATE SEQUENCE O_INFO_SEQ
    MAXVALUE 99999
    NOCACHE
    NOCYCLE;


CREATE TABLE ORDER_INFO (
    ORDER_NO        NUMBER(15)       PRIMARY KEY,
    ORDER_DATE      DATE            DEFAULT SYSDATE,
    C_ID            VARCHAR2(10)    REFERENCES CUSTOMER (C_ID),
    ORDER_ADDRESS   VARCHAR2(300)   NOT NULL,
    ORDER_TEL       VARCHAR2(20)    NOT NULL );
    
-- 주문상세정보
CREATE SEQUENCE O_DETAIL_SEQ
    MAXVALUE 9999
    NOCACHE
    NOCYCLE;

CREATE TABLE ORDER_DETAIL (
    ORDER_NO    NUMBER(15)       REFERENCES ORDER_INFO (ORDER_NO),
    P_CODE      VARCHAR2(3)     REFERENCES PRODUCT (P_CODE),
    O_AMOUNT      NUMBER(3),
    COST_TOT   NUMBER(7),
    CHECK (O_AMOUNT > 0),
    CHECK (COST_TOT > 0) );

-- 홍길동 주문

-- (1) 카트 담기
INSERT INTO CART VALUES (CART_SEQ.NEXTVAL, 'abc', 'A1', 3, 3*3000);
UPDATE PRODUCT SET STOCK = STOCK - 3 WHERE P_CODE = 'A1';
INSERT INTO CART VALUES (CART_SEQ.NEXTVAL, 'abc', 'A2', 2, 2*2000);
UPDATE PRODUCT SET STOCK = STOCK - 2 WHERE P_CODE = 'A2';
INSERT INTO CART VALUES (CART_SEQ.NEXTVAL, 'abc', 'B1', 1, 3500);
UPDATE PRODUCT SET STOCK = STOCK - 1 WHERE P_CODE = 'B1';
INSERT INTO CART VALUES (CART_SEQ.NEXTVAL, 'abc', 'B2', 1, 5000);
UPDATE PRODUCT SET STOCK = STOCK - 1 WHERE P_CODE = 'B2';

SELECT * FROM CART;

-- 상품 재고 현황
SELECT * FROM PRODUCT;

-- (2) 주문)
INSERT INTO ORDER_INFO VALUES (TO_NUMBER(TO_CHAR(SYSDATE, 'YYMMDD')||TRIM(TO_CHAR(O_INFO_SEQ.NEXTVAL, '00000'))), SYSDATE, 'abc', '서울시 강남구', '010-1111-1111');
DELETE FROM ORDER_INFO WHERE C_ID = 'abc';
SELECT * FROM ORDER_INFO;

-- 주문 상세
INSERT INTO ORDER_DETAIL VALUES (22041900001, 'A1', 3, 3*3000);
INSERT INTO ORDER_DETAIL VALUES (22041900001, 'A2', 2, 2*2000);
INSERT INTO ORDER_DETAIL VALUES (22041900001, 'B1', 1, 3500);
INSERT INTO ORDER_DETAIL VALUES (22041900001, 'B2', 1, 5000);

SELECT P_CODE, P_NAME, PRICE, O_AMOUNT, COST_TOT FROM ORDER_DETAIL;
-- 주문완료

TRUNCATE TABLE CART;
TRUNCATE TABLE ORDER_DETAIL;


-- 전투왕 주문

-- (1) 카트담기
INSERT INTO CART VALUES (CART_SEQ.NEXTVAL, 'def', 'A2', 2, 2*2000);
UPDATE PRODUCT SET STOCK = STOCK - 2 WHERE P_CODE = 'A2';
INSERT INTO CART VALUES (CART_SEQ.NEXTVAL, 'def', 'B2', 1, 5000);
UPDATE PRODUCT SET STOCK = STOCK - 1 WHERE P_CODE = 'B2';
INSERT INTO CART VALUES (CART_SEQ.NEXTVAL, 'def', 'C1', 1, 7000);
UPDATE PRODUCT SET STOCK = STOCK - 1 WHERE P_CODE = 'C1';

-- 상품 재고 현황
SELECT * FROM PRODUCT;

-- (2) 주문)
INSERT INTO ORDER_INFO VALUES (TO_CHAR(SYSDATE, 'YYMMDD')||TO_CHAR(O_INFO_SEQ.NEXTVAL, '00000'), SYSDATE, 'def', '서울시 서대문구', '010-2222-2222');

-- 주문상세
INSERT INTO ORDER_DETAIL VALUES (22041900002, 'A2', 2, 2*2000);
INSERT INTO ORDER_DETAIL VALUES (22041900002, 'B2', 1, 5000);
INSERT INTO ORDER_DETAIL VALUES (22041900002, 'C1', 1, 7000);
-- 주문완료
-- 카트 비우기
TRUNCATE TABLE CART;
-- 상세내역 지우기
TRUNCATE TABLE ORDER_DETAIL;

-- 홍길동(과천) 카트

-- (1) 카트담기
INSERT INTO CART VALUES (CART_SEQ.NEXTVAL, 'abc', 'A1', 2, (SELECT PRICE FROM PRODUCT WHERE P_CODE = 'A1')*2);
UPDATE PRODUCT SET STOCK = STOCK - 2 WHERE P_CODE = 'A1';
INSERT INTO CART VALUES (CART_SEQ.NEXTVAL, 'abc', 'B1', 1, (SELECT PRICE FROM PRODUCT WHERE P_CODE = 'A1'));
UPDATE PRODUCT SET STOCK = STOCK - 1 WHERE P_CODE = 'B1';
INSERT INTO CART VALUES (CART_SEQ.NEXTVAL, 'abc', 'C1', 1, (SELECT PRICE FROM PRODUCT WHERE P_CODE = 'C1'));
UPDATE PRODUCT SET STOCK = STOCK - 1 WHERE P_CODE = 'C1';

-- 상품 재고 현황
SELECT * FROM PRODUCT;

-- (2) 주문)
INSERT INTO ORDER_INFO VALUES (TO_CHAR(SYSDATE, 'YYMMDD')||TO_CHAR(O_INFO_SEQ.NEXTVAL, '00000'), SYSDATE, 'abc', '경기도 과천시', '010-3333-3333');

-- 주문상세
INSERT INTO ORDER_DETAIL VALUES (22041900003, 'A1', 2, 2*3000);
INSERT INTO ORDER_DETAIL VALUES (22041900003, 'B1', 1, 5000);
INSERT INTO ORDER_DETAIL VALUES (22041900003, 'C1', 1, 7000);
-- 주문완료

TRUNCATE TABLE CART;
TRUNCATE TABLE ORDER_DETAIL;

DROP TABLE ORDER_DETAIL;
DROP TABLE ORDER_INFO;
DROP TABLE CART;
DROP SEQUENCE CART_SEQ;
DROP SEQUENCE O_INFO_SEQ;
DROP TABLE PRODUCT;
